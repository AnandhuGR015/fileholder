<!DOCTYPE html>
<html>
  <head>
    <title>Lead Flow HTML</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <style>
      body {
        background-color: white;
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 20px;
      }
      .header-image {
        display: block;
        margin: 0 auto 20px auto;
        max-width: 100%;
        height: auto;
      }
      .summary-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .summary-box {
        flex: 1;
        background-color: navy;
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        color: white;
      }
      .summary-box h3 {
        font-size: 1rem;
        margin-bottom: 10px;
        color: white;
      }
      .summary-box p {
        font-size: 1.5rem;
        margin: 0;
        color: white;
      }
      .summary-box strong {
        color: white;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        padding: 8px;
        border: 1px solid #ccc;
        text-align: left;
      }
      th {
        background-color: navy;
        color: white;
      }
      .top-row td {
        background-color: #c8f7c5 !important;
      }
      .other-row td {
        background-color: #fff9c4 !important;
      }
    </style>
    <script>
      function loadData() {
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvnwU__CRe_QNBXnO1huqhUdn7A6OHNT5RmJ5HUQARqWzwiV7BgoVsDmGwvoblCs95F7ASJLedFfgr/pub?gid=1451083927&single=true&output=csv';

        Papa.parse(csvUrl, {
          download: true,
          header: true,
          complete: function (results) {
            const data = results.data.filter(row => row['No of Leads'] && !isNaN(row['No of Leads']));
            if (data.length === 0) {
              document.getElementById('table_div').innerText = 'No data available.';
              return;
            }

            const leadSourceCount = {};
            const leadSourceConversions = {};
            let totalConversions = 0;

            data.forEach(row => {
              const source = row['Lead Source']?.trim();
              const leads = parseInt(row['No of Leads'], 10);
              const conversions = parseInt(row['Conversion'], 10);

              if (source) {
                if (!isNaN(leads)) {
                  leadSourceCount[source] = (leadSourceCount[source] || 0) + leads;
                }
                if (!isNaN(conversions)) {
                  leadSourceConversions[source] = (leadSourceConversions[source] || 0) + conversions;
                  totalConversions += conversions;
                }
              }
            });

            let topSource = 'N/A';
            let maxLeads = 0;
            Object.entries(leadSourceCount).forEach(([source, count]) => {
              if (count > maxLeads) {
                maxLeads = count;
                topSource = source;
              }
            });

            document.getElementById('summary1').innerHTML =
              `<span style="font-size: 2rem;">ðŸ‘‘</span><br><strong>${topSource}</strong>`;

            if (totalConversions === 0) {
              document.getElementById('summary2').innerHTML = `<strong>Still Converting</strong>`;
            } else {
              let bestSource = 'N/A';
              let bestRate = 0;
              Object.keys(leadSourceCount).forEach(source => {
                const leads = leadSourceCount[source];
                const conv = leadSourceConversions[source] || 0;
                const rate = conv / leads;
                if (!isNaN(rate) && rate > bestRate) {
                  bestRate = rate;
                  bestSource = source;
                }
              });

              document.getElementById('summary2').innerHTML =
                `<span style="font-size: 2rem;">ðŸ‘‘</span><br><strong>${bestSource}</strong>`;
            }

            // Sort data by 'No of Leads' descending
            data.sort((a, b) => parseInt(b['No of Leads']) - parseInt(a['No of Leads']));

            const tableDiv = document.getElementById('table_div');
            tableDiv.innerHTML = '';
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(col => {
              const th = document.createElement('th');
              th.textContent = col;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            data.forEach((row, index) => {
              const tr = document.createElement('tr');
              tr.className = index < 2 ? 'top-row' : 'other-row';
              Object.values(row).forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            tableDiv.appendChild(table);
          },
          error: function (error) {
            document.getElementById('table_div').innerText = 'Failed to load CSV: ' + error.message;
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function () {
        loadData();
        setInterval(loadData, 60000); // Auto-refresh every 1 minute
      });
    </script>
  </head>
  <body>
    <img src="https://anandhu-tech.github.io/partnerright/PartnerRight.png" alt="Header Image" class="header-image" />
    <div class="summary-container">
      <div class="summary-box">
        <h3>Top Lead Source</h3>
        <p id="summary1">Calculating...</p>
      </div>
      <div class="summary-box">
        <h3>Best Conversion Source</h3>
        <p id="summary2">Calculating...</p>
      </div>
    </div>
    <h3>Daily Lead Flow</h3>
    <div id="table_div"></div>
    <noscript>
      JavaScript is required to view the table. Please enable it in your browser settings.
    </noscript>
  </body>
</html>
